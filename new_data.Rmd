---
title: "New Data Analysis"
author: "Jiayi Yang"
date: "2022-11-16"
output: github_document
---
```{r setup, include=FALSE}
library(tidyverse)
library(readxl)
library(lubridate)
library(dplyr)
library(ggridges)
library(ggplot2)
```
```{r}
library("MatchIt")
```


import the new data
```{r, message=FALSE}
new_data = 
  read_excel("./LDA.xlsx", sheet = 1, range = cell_cols("A:K")) %>% 
  filter(flo_meas_name %in% c(  'G IP NYC LDA MIDLINE DOUBLE LUMEN',
                                'G IP NYC LDA MIDLINE SINGLE LUMEN',
                                'G LDA PULMONARY ARTERY CATHETER/SWAN GANZ',
                                'LDA CVC QUADRUPLE LUMEN',
                                'LDA CVC SINGLE LUMEN',
                                'LDA CVC TRIPLE LUMEN',
                                'LDA DUAL LUMEN PORT',
                                'LDA EXTERNAL URINARY CATHETER',
                                'LDA PICC SINGLE LUMEN',
                                'LDA PICC TRIPLE LUMEN',
                                'LDA PUMP DEVICE',
                                'NYC LDA PRESSURE INJURY',
                                'RETIRED - NYC ADT TC PICC DOUBLE LUMEN')
         ) %>% 
  mutate(
    placement_date = as.Date(PLACEMENT_INSTANT, "%y/%m/%d"),
    removal_date = as.Date(REMOVAL_INSTANT, "%y/%m/%d"),
    duration = removal_date - placement_date
  ) %>% 
  filter(removal_date != '2157-11-19')

new_data
```

We have `r nrow(new_data)` patients who have central lines inserted in our sample

```{r}
bcp_df =
  read_excel("./CLABSI_data.xlsx", sheet = 3, range = cell_cols("A:K")) %>% 
  arrange(EMPI) %>% 
  select(EMPI, PROC_NAME, RESULT_TIME) %>% 
  filter(PROC_NAME == "BLOOD CULTURE") %>% 
  mutate(
  status = "blood_culture_positive",
  date = as.Date(RESULT_TIME, "%y/%m/%d")
)  %>% 
  distinct(EMPI, date, .keep_all = TRUE)
bcp_df
```
We have `r nrow(bcp_df)` patients who have blood culture positive shown in the EMR in our sample

Next, see if result_time of BCP aligns with central line insert period.
Trying to join central_lined_df and bcp_df to see patients who are cl inserted and bcp during their central line placement period.

```{r}
join_test=
join_cl_bcp =
  left_join(new_data, bcp_df, by = c("EMPI")) %>%
  mutate(
   period_1 = interval(ymd(placement_date), ymd(removal_date)),
    bcp_status = ifelse(date %within% period_1, 1, 0)
  ) %>%    
drop_na() %>% 
  select(EMPI, bcp_status, date, placement_date, removal_date, period_1) %>% 
  arrange(EMPI, desc(bcp_status))
  
join_test2 = join_test[!duplicated(join_test$EMPI), ] %>% 
  mutate(
    matching_period = date - placement_date
  )

table(join_test2$bcp_status)
```

Great, we found 591 observations of patients who have blood culture positive within their periods of central line inserted. 

The incidence for blood culture positive in central lined patients are 591/6754 = 8.75%

Now we try to match controls to cases by first full join the bcp_status table (join_test2) with our original new_data table:
```{r}
full_table = 
  full_join(new_data, join_test2, by = c("EMPI")) 
full_table2 = full_table[!duplicated(full_table$EMPI), ] 

full_table2$bcp_status[is.na(full_table2$bcp_status)] <- 0

table(full_table2$bcp_status)
```
We have 591 cases and 1844 unique controls to pool from. `full_table2` is the full table until now.

Matching by variable `matching_period` which stands for the time between central line placement and tested blood culture positive

by MatchIt:
```{r}
full_table3 = full_table2 %>% 
  drop_na(matching_period)

set.seed(1234)
match.it <- matchit(bcp_status ~ matching_period, data = full_table3, method="nearest", ratio=1)
matched_df <- summary(match.it)

knitr::kable(matched_df$nn, digits = 2, align = 'c', 
      caption = 'Table 2: Sample sizes')

```
Have a warning: fewer controls than cases, not all cases will get a match

??save the matched dataset into a new dataframe named `df.match`
```{r}
df.match <- match.data(match.it)[1:ncol(full_table3)]
rm(matched_df)

df.match %>% 
  mutate(
    BIRTH_DATE = as.Date(BIRTH_DATE, "%y/%m/%d")
  )
```
df.match has 568 observations include 284 cases and 284 controls

demographic analysis: age, gender
```{r}
library(lemon)
   age <- function(BIRTH_DATE, on.day=today()) {
    intvl <- interval(BIRTH_DATE, on.day)
    prd <- as.period(intvl)
    return(prd@year)
   }
pop = sample(x = 1:100, size = 20)
ggplot(df.match, aes(x = ifelse(test = sex_c == 1, yes = -pop, no = pop), y = BIRTH_DATE, fill = sex_c)) +
  geom_col() +
  scale_x_symmetric(labels = abs) +
  labs(x = "Population")
```

Look at the exposure TPN status
Next, we look at TPN data
```{r}
tpn_df =
   read_excel("./CLABSI_data.xlsx", sheet = 4, range = cell_cols("A:K")) %>% 
  arrange(EMPI) %>% 
  select(EMPI, START_DATE, END_DATE) %>% 
  mutate(
    status = "tpn"
  )
join_tpn = 
  left_join(df.match, tpn_df, by = c("EMPI")) %>% 
  mutate(
    tpn_status = ifelse(START_DATE %within% period_1, 1, 0)
  ) %>% 
  drop_na() %>% 
  select(EMPI, bcp_status, period_1, START_DATE, END_DATE, tpn_status) %>% 
  distinct(EMPI, tpn_status, .keep_all = TRUE)
join_tpn <- table(join_tpn$tpn_status, join_tpn$bcp_status)
join_tpn

  
```

