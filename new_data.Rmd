---
title: "newdata"
author: "Jiayi Yang"
date: "2022-11-16"
output: html_document
---
```{r setup, include=FALSE}
library(tidyverse)
library(readxl)
library(lubridate)
library(dplyr)
library(ggridges)
```
import the new data
```{r, message=FALSE}
new_data = 
  read_excel("./LDA.xlsx", sheet = 1, range = cell_cols("A:K")) %>% 
  filter(flo_meas_name %in% c(  'G IP NYC LDA MIDLINE DOUBLE LUMEN',
                                'G IP NYC LDA MIDLINE SINGLE LUMEN',
                                'G LDA PULMONARY ARTERY CATHETER/SWAN GANZ',
                                'LDA CVC QUADRUPLE LUMEN',
                                'LDA CVC SINGLE LUMEN',
                                'LDA CVC TRIPLE LUMEN',
                                'LDA DUAL LUMEN PORT',
                                'LDA EXTERNAL URINARY CATHETER',
                                'LDA PICC SINGLE LUMEN',
                                'LDA PICC TRIPLE LUMEN',
                                'LDA PUMP DEVICE',
                                'NYC LDA PRESSURE INJURY',
                                'RETIRED - NYC ADT TC PICC DOUBLE LUMEN')
         ) %>% 
  mutate(
    placement_date = as.Date(PLACEMENT_INSTANT, "%y/%m/%d"),
    removal_date = as.Date(REMOVAL_INSTANT, "%y/%m/%d"),
    duration = removal_date - placement_date
  ) %>% 
  filter(removal_date != '2157-11-19')

new_data
```

We have `r nrow(new_data)` patients who have central lines inserted in our sample

```{r}
bcp_df =
  read_excel("./CLABSI_data.xlsx", sheet = 3, range = cell_cols("A:K")) %>% 
  arrange(EMPI) %>% 
  select(EMPI, PROC_NAME, RESULT_TIME) %>% 
  filter(PROC_NAME == "BLOOD CULTURE") %>% 
  mutate(
  status = "blood_culture_positive",
  date = as.Date(RESULT_TIME, "%y/%m/%d")
)  %>% 
  distinct(EMPI, date, .keep_all = TRUE)
bcp_df
```
We have `r nrow(bcp_df)` patients who have blood culture positive shown in the EMR in our sample

Next, see if result_time of BCP aligns with central line insert period.
Trying to join central_lined_df and bcp_df to see patients who are cl inserted and bcp during their central line placement period.

```{r}
join_test=
join_cl_bcp =
  left_join(new_data, bcp_df, by = c("EMPI")) %>%
  mutate(
   period_1 = interval(ymd(placement_date), ymd(removal_date)),
    bcp_status = ifelse(date %within% period_1, 1, 0)
  ) %>%    
drop_na() %>% 
  select(EMPI, bcp_status, date, placement_date, removal_date, period_1) %>% 
  arrange(EMPI, desc(bcp_status))
  
join_test2 = join_test[!duplicated(join_test$EMPI), ]

bcp_positive = 
  join_test2 %>% 
  filter(bcp_status == "1") %>% 
  count(bcp_status)
```

Great, we found 591 observations of patients who have blood culture positive within their periods of central line inserted. 

The incidence for blood culture positive in central lined patients are 591/6754 = 8.75%