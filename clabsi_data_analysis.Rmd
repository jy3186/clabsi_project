---
title: "clabsi_data_analysis"
author: "Jiayi Yang"
date: "2022-10-04"
output: github_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(readxl)
library(lubridate)
library(dplyr)
```

Importing and tidying CLABSI data, keeping duplicative dates appeared patients only once

```{r}
central_lined_df =
  read_excel("./CLABSI_data.xlsx", sheet = 1, range = cell_cols("A:G")) %>% 
  arrange(EMPI) %>% 
  select(EMPI, ordering_date) %>% 
mutate(
  status = "central_lined",
  end_date = ymd(ordering_date) + days(14)
) %>% 
  distinct(EMPI, ordering_date, .keep_all = TRUE) %>% 
  mutate(
      period_1 = interval(ymd(ordering_date), ymd(end_date)),
      date = ordering_date
  ) %>% 
  select(EMPI, status, date, period_1)

central_lined_df
```
We have `r nrow(central_lined_df)` patients who have central lines inserted in our sample

Bloodstream Infectious importing and cleaning
```{r}
bcp_df =
  read_excel("./CLABSI_data.xlsx", sheet = 3, range = cell_cols("A:K")) %>% 
  arrange(EMPI) %>% 
  select(EMPI, PROC_NAME, RESULT_TIME) %>% 
  filter(PROC_NAME == "BLOOD CULTURE") %>% 
  mutate(
  status = "blood_culture_positive",
  date = as.Date(RESULT_TIME, "%y/%m/%d")
)  %>% 
  distinct(EMPI, date, .keep_all = TRUE)
bcp_df
```

We have `r nrow(bcp_df)` patients who have blood culture positive shown in the EMR in our sample

Next, see if result_time of BCP aligns with central line insert period.
Trying to join central_lined_df and bcp_df to see patients who are cl inserted and bcp
```{r}
join_cl_bcp =
  left_join(central_lined_df, bcp_df, by = c("EMPI")) %>% 
  mutate(
    join_status = ifelse(date.y %within% period_1, 1, 0)
  ) %>% 
   filter(join_status == 1) %>% 
  select(EMPI, join_status, date.y)

join_cl_bcp
```
Combined the `central_line_df` (population) with `join_cl_bcp`(cases) to a single dataframe `plot_df` to plot a histogram
```{r}
plot_df = 
  left_join(central_lined_df, join_cl_bcp, by = "EMPI") %>% 
  distinct(EMPI, across(contains ("period_1")), .keep_all = TRUE)
plot_df
```

Great, we found `r nrow(join_cl_bcp)` observations of patients who have blood culture positive within the 14-day period of central line inserted. 

Incidence of bcp in central lined patients are `r nrow(join_cl_bcp)` / `r nrow(central_lined_df)`.


Next, we look at TPN data
```{r}
tpn_df =
   read_excel("./CLABSI_data.xlsx", sheet = 4, range = cell_cols("A:K")) %>% 
  arrange(EMPI) %>% 
  select(EMPI, START_DATE, END_DATE) %>% 
  mutate(
    status = "tpn"
  ) %>% 
  distinct(EMPI, .keep_all = TRUE)
tpn_df
```
## R Markdown
